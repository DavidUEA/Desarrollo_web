{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-9">
            <h1 class="mb-4 text-center">Registrar Nueva Venta</h1>

            <form method="POST" action="{{ url_for('crear_venta') }}" id="venta-form">
                {{ form.hidden_tag() }}

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Seleccionar Cliente</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.cliente_id.label(class="form-label fw-bold") }}
                            {{ form.cliente_id(class="form-select", required=True) }}
                            {% for error in form.cliente_id.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">2. Productos a Vender</h5>
                        <button type="button" id="btn-anadir-producto" class="btn btn-sm btn-light">
                            <i class="bi bi-plus-circle"></i> + Añadir Producto
                        </button>
                    </div>
                    
                    <div class="card-body">
                        <div id="productos-a-vender">
                            {# Estructura HTML para los productos #}
                            {% for detalle in form.detalles %}
                                <div class="row mb-3 align-items-end detalle-row" data-index="{{ loop.index0 }}">
                                    
                                    {# Campo Producto ID #}
                                    <div class="col-6 col-md-4">
                                        {# Eliminamos 'sr-only' y usamos 'd-md-none' para mostrar en móvil si es necesario #}
                                        {{ detalle.producto_id.label(class="form-label d-md-none") }}
                                        {{ detalle.producto_id(class="form-select producto-select", required=True) }}
                                        {% for error in detalle.producto_id.errors %}
                                            <div class="text-danger small mt-1">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    
                                    {# Campo Cantidad #}
                                    <div class="col-3 col-md-2">
                                        {{ detalle.cantidad.label(class="form-label d-md-none") }}
                                        {{ detalle.cantidad(class="form-control cantidad-input", type="number", min=1, required=True, value=detalle.cantidad.data or 1) }}
                                        {% for error in detalle.cantidad.errors %}
                                            <div class="text-danger small mt-1">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    
                                    {# Campo de Precio (OCULTO) #}
                                    <div class="d-none">
                                        {# Este campo debe contener el valor si viene de un formulario cargado (edición) #}
                                        {{ detalle.precio_unitario(class="precio-unitario-input") }}
                                    </div>

                                    {# Subtotal (Mostrar solo con JS) #}
                                    <div class="col-md-3 -md-4 text-end">
                                        <p class="mb-0 fw-bold pt-2 pt-md-0">
                                            Subtotal: $<span class="subtotal-display">0.00</span>
                                        </p>
                                    </div>
                                    
                                    {# Botón Eliminar #}
                                    <div class=""col-12 col-md-2">
                                        <button type="button" class="btn btn-sm btn-outline-danger eliminar-producto w-100" title="Eliminar Producto">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div> 
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <h2 class="mb-0">
                            TOTAL VENTA: $<span id="total-venta" class="text-success fw-bolder">0.00</span>
                        </h2>
                    </div>
                    <div class="card-footer">
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg") }} 
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // **IMPORTANTE: Asegúrate de que Flask pase 'productos_json'**
        // productsData es { 'producto_id': precio_unitario, ... }
        const productsData = JSON.parse('{{ productos_json | safe }}'); 
        
        const container = document.getElementById('productos-a-vender');
        const btnAnadir = document.getElementById('btn-anadir-producto');
        const totalVentaDisplay = document.getElementById('total-venta');
        
        const initialRows = container.querySelectorAll('.detalle-row');
        let index = initialRows.length;
        
        // Creamos la plantilla de clonación
        let templateRow = null;
        if (initialRows.length > 0) {
            let lastRow = initialRows[initialRows.length - 1]; 
            templateRow = lastRow.cloneNode(true);
            
            // Limpieza del template para nuevas filas
            const newSelect = templateRow.querySelector('.producto-select');
            if(newSelect && newSelect.options.length > 0) {
                 newSelect.value = newSelect.options[0].value; 
            }
            templateRow.querySelector('.cantidad-input').value = 1;
            templateRow.querySelector('.subtotal-display').textContent = '0.00';
            templateRow.querySelector('.precio-unitario-input').value = '0.00';
            templateRow.querySelectorAll('.text-danger').forEach(el => el.remove()); 
            templateRow.removeAttribute('data-index'); // Se asigna al añadir
            
        } else {
             // Si no hay filas iniciales, deberías asegurar que Flask siempre inicie FieldList con al menos una.
             // Si el FieldList viene vacío (0 filas), no se puede crear un template a partir del HTML.
             // En este caso, el botón de añadir debe ser presionado para crear la primera fila si es posible.
             console.warn("No se encontró una fila de plantilla inicial. Verifique la inicialización del FieldList en Flask.");
        }

        // --- Funciones de Lógica de Indexación y Eliminación ---
        
        // Re-indexa todas las filas después de una eliminación (CRUCIAL para WTForms)
        function reindexRows() {
            const rows = container.querySelectorAll('.detalle-row');
            rows.forEach((row, newIndex) => {
                // Función para reajustar names e ids (detalles-0-...)
                const regex = /detalles-\d+-/g;
                const newNamePrefix = `detalles-${newIndex}-`;

                row.querySelectorAll('[name], [id]').forEach(el => {
                    if (el.name) el.name = el.name.replace(regex, newNamePrefix);
                    if (el.id) el.id = el.id.replace(regex, newNamePrefix);
                });
                row.setAttribute('data-index', newIndex);
            });
            index = rows.length; // Actualiza el índice global para la próxima adición
        }

        // Manejador para eliminar una fila
        function handleEliminar(event) {
            event.preventDefault(); 
            
            // Revisa si es el botón o el icono el que se pulsó
            const clickedElement = event.target.closest('.eliminar-producto');
            if (!clickedElement) return;
            
            // No permitir eliminar si solo queda una fila
            const rows = container.querySelectorAll('.detalle-row');
            if (rows.length <= 1) {
                alert("Una venta debe tener al menos un producto.");
                return;
            }

            const rowToRemove = clickedElement.closest('.detalle-row');
            if (rowToRemove) {
                rowToRemove.remove();
                reindexRows();
                calcularTotalVenta();
            }
        }

        // --- Funciones de Lógica de Cálculo ---
        
        function calcularSubtotal(row) {
            const select = row.querySelector('.producto-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const precioInput = row.querySelector('.precio-unitario-input');
            const subtotalSpan = row.querySelector('.subtotal-display');
            
            const productoId = select.value;
            // Aseguramos cantidad mínima de 1 (si el input es 0 o negativo)
            const cantidad = Math.max(1, parseFloat(cantidadInput.value) || 1); 
            cantidadInput.value = cantidad; 

            // 1. Obtener el precio: Si hay un precio en productsData, úsalo. Si no, usa el valor oculto (útil en modo editar).
            let precioUnitario = parseFloat(productsData[productoId]) || parseFloat(precioInput.value) || 0.00;
            
            // 2. Actualizar campo oculto de precio
            precioInput.value = precioUnitario.toFixed(2); 

            // 3. Calcular y mostrar subtotal
            const subtotal = cantidad * precioUnitario;
            subtotalSpan.textContent = subtotal.toFixed(2);
            
            calcularTotalVenta();
        }

        function calcularTotalVenta() {
            let total = 0;
            container.querySelectorAll('.subtotal-display').forEach(span => {
                total += parseFloat(span.textContent) || 0;
            });
            totalVentaDisplay.textContent = total.toFixed(2);
        }

        // --- Inicialización y Event Listeners ---
        
        // Añadir listeners de cálculo y eliminación a una fila
        function addListenersToRow(row) {
            // Recalculo al cambiar el producto o la cantidad
            row.querySelectorAll('.producto-select, .cantidad-input').forEach(input => {
                input.addEventListener('change', () => calcularSubtotal(row)); 
                input.addEventListener('input', () => calcularSubtotal(row)); 
            });
            
            // Listener para el botón de eliminar
            const btnEliminar = row.querySelector('.eliminar-producto');
            if(btnEliminar) {
                btnEliminar.addEventListener('click', handleEliminar);
            }
        }
        
        // Evento del Botón "Añadir Producto"
        btnAnadir.addEventListener('click', function() {
            if (!templateRow) {
                alert("Error al cargar la plantilla de producto. No se puede añadir.");
                return;
            }

            const newRow = templateRow.cloneNode(true); 
            
            // Configuración inicial de la nueva fila
            const newSelect = newRow.querySelector('.producto-select');
            if(newSelect) { newSelect.value = newSelect.options[0].value; } // Asegura que se seleccione la primera opción
            newRow.querySelector('.cantidad-input').value = 1;

            // Asignar el nuevo índice y actualizar names/ids
            reindexRows(); // Reindexa los elementos existentes antes de añadir (solo por seguridad)
            // Ya que reindexRows() actualiza el índice global, el nuevo índice es 'index'.
            newRow.setAttribute('data-index', index);
            
            // Esta llamada es crucial para que el nuevo elemento tenga los nombres de campo correctos (ej: detalles-X-...)
            const regex = /detalles-\d+-/g;
            const newNamePrefix = `detalles-${index}-`;
            newRow.querySelectorAll('[name], [id]').forEach(el => {
                if (el.name) el.name = el.name.replace(regex, newNamePrefix);
                if (el.id) el.id = el.id.replace(regex, newNamePrefix);
            });
            
            // Insertar en el DOM
            container.appendChild(newRow);
            
            // Añadir los listeners de evento a la nueva fila
            addListenersToRow(newRow);
            
            // Inicializar subtotal (toma el valor del producto seleccionado o 0.00)
            calcularSubtotal(newRow);
            
            // Incrementar el índice global
            index++; 
        });
        
        // --- INICIALIZACIÓN AL CARGAR LA PÁGINA ---

        // 1. Inicializar listeners y calcular para filas que existen al cargar
        // ESTE PASO ACTIVA LA ELIMINACIÓN Y EL CÁLCULO EN LAS FILAS EXISTENTES
        if (initialRows.length > 0) {
            initialRows.forEach(row => {
                addListenersToRow(row);
                calcularSubtotal(row); 
            });
        }
        
        // 2. Si no hay filas iniciales y tenemos la plantilla, forzamos la adición de la primera fila.
        // Esto es útil si el FieldList de Flask no se inicializa con una entrada vacía.
        if (initialRows.length === 0 && templateRow) {
            btnAnadir.click();
        }

        // 3. Cálculo final del total
        calcularTotalVenta();
    });
</script>

{% endblock %}